package com.fujitsu.edgewareroad.trivyutils.dto.trivyscan;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.builder.HashCodeBuilder;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fujitsu.edgewareroad.trivyutils.dto.VulnerabilityScorePriorityThresholds;

public class TrivyScanVulnerability implements Comparable<TrivyScanVulnerability>
{
    @JsonProperty("VulnerabilityID")
    private String vulnerabilityID;
    @JsonProperty("Severity")
    private VulnerabilitySeverity severity;
    @JsonProperty("CVSSScore")
    private Double cvssScore;
    @JsonProperty("EPSSScore")
    private Double epssScore = null;
    @JsonProperty("Title")
    private String title;
    @JsonProperty("Description")
    private String description;
    @JsonProperty("PrimaryURL")
    private URI primaryURL;
    @JsonProperty("WasInPreviousScan")
    private Boolean wasInPreviousScan = null;
    @JsonProperty("PackageVulnerabilities")
    private TrivyScanPackageVulnerabilities packageVulnerabilities = new TrivyScanPackageVulnerabilities();
    @JsonProperty
    private boolean isPrioritised = true;
    @JsonIgnore
    private double priorityOrder;

    protected TrivyScanVulnerability(TrivyScanVulnerability vulnerability)
    {
        this.vulnerabilityID = vulnerability.vulnerabilityID;
        this.severity = vulnerability.severity;
        this.cvssScore = vulnerability.cvssScore;
        this.epssScore = vulnerability.epssScore;
        this.title = vulnerability.title;
        this.description = vulnerability.description;
        this.primaryURL = vulnerability.primaryURL;
        this.wasInPreviousScan = vulnerability.wasInPreviousScan;
        this.packageVulnerabilities.addAll(vulnerability.getPackageVulnerabilities());
        this.isPrioritised = vulnerability.isPrioritised;
        recalculatePriorityOrder();
    }

    public TrivyScanVulnerability(TrivyScanPackageVulnerability vulnerabilityFromScan)
    {
        vulnerabilityID = vulnerabilityFromScan.getVulnerabilityID();
        severity = vulnerabilityFromScan.getSeverity();
        cvssScore = vulnerabilityFromScan.getCVSSScore();
        primaryURL = vulnerabilityFromScan.getPrimaryURL();
        title = vulnerabilityFromScan.getTitle();
        description = vulnerabilityFromScan.getDescription();
        packageVulnerabilities.add(vulnerabilityFromScan);
        recalculatePriorityOrder();
    }
    
    public String getVulnerabilityID() {
        return vulnerabilityID;
    }

    public VulnerabilitySeverity getSeverity() {
        return severity;
    }

    public Double getCVSSScore() {
        return cvssScore;
    }

    public Double getEPSSScore() {
        return epssScore;
    }

    public double getEPSSScoreNormalised() {
        return epssScore == null ? Double.MIN_VALUE : epssScore;
    }

    public void setEPSSScore(Double epssScore) {
        this.epssScore = epssScore;
        recalculatePriorityOrder();
    }

    public boolean getIsPriorityForRemediation()
    {
        return isPrioritised;
    }

    public void prioritiseForRemediation(VulnerabilityScorePriorityThresholds priorityThresholds)
    {
        if (priorityThresholds != null && priorityThresholds.supportsDeprioritisation())
        {
            isPrioritised = (cvssScore >= priorityThresholds.getMinimumCVSS()) && (getEPSSScoreNormalised() >= priorityThresholds.getMinimumEPSS());
        }
        else
        {
            isPrioritised = true;
        }
        recalculatePriorityOrder();
    }

    public URI getPrimaryURL() {
        return primaryURL;
    }

    public String getTitle() {
        return title;
    }

    public String getDescription() {
        return description;
    }

    public Boolean getWasInPreviousScan() {
        return wasInPreviousScan;
    }

    public List<URI> getReferences() {
        ArrayList<URI> refs = new ArrayList<>();
        if (packageVulnerabilities != null)
        {
            for (TrivyScanPackageVulnerability packageVulnerability : packageVulnerabilities)
            {
                if (packageVulnerability.getReferences() != null)
                {
                    for (String refURIAsString : packageVulnerability.getReferences())
                    {
                        try {
                            URI refURI = URI.create(refURIAsString);
                            if (!refs.contains(refURI)) refs.add(refURI);
                        } catch (Exception e)
                        {
                            // Ignore it - wasn't a genuine URL
                        }
                    }
                }
            }
        }
        return refs;
    }
    
    public URI getNvdReference()
    {
        for(URI ref : getReferences())
        {
            try {
                if (ref.getHost().equals("nvd.nist.gov") && ref.getPath().startsWith("/vuln/detail/")) return ref;
            } catch (Exception e) {
                // Silently swallow the problem as the URI couldn't match this
            }
        }
        return null;
    }
    
    public URI getRedhatReference()
    {
        for(URI ref : getReferences())
        {
            try {
                if (ref.getHost().equals("access.redhat.com") && ref.getPath().startsWith("/security/cve/")) return ref;
            } catch (Exception e) {
                // Silently swallow the problem as the URI couldn't match this
            }
        }
        return null;
    }

    /**
     * Only used if a previous scan was conducted. Sets whether this is a new observation (false) or an old one (true)
     * @param inPreviousScan
     */
    public void setWasInPreviousScan(boolean inPreviousScan)
    {
        wasInPreviousScan = inPreviousScan;
    }

    public TrivyScanPackageVulnerabilities getPackageVulnerabilities()
    {
        return packageVulnerabilities;
    }

    protected void addPackageVulnerability(TrivyScanPackageVulnerability packageVulnerability)
    {
        packageVulnerabilities.add(packageVulnerability);
        if (cvssScore < packageVulnerability.getCVSSScore())
        {
            cvssScore = packageVulnerability.getCVSSScore();
        }
    }

    @Override
    public int hashCode() {
        HashCodeBuilder builder = new HashCodeBuilder(17, 23)
            .append(vulnerabilityID);
        return builder.toHashCode();
    }

    @Override
    public boolean equals(Object obj) {
        if (obj instanceof TrivyScanVulnerability)
        {
            TrivyScanVulnerability o = (TrivyScanVulnerability)obj;
            return vulnerabilityID.equals(o.vulnerabilityID);
        }
        else return false;
    }

    private void recalculatePriorityOrder() {
        Double order = isPrioritised ? 100000000000.0d : 0.0d;
        order += severity.ordinal() * 1000000000d;
        order += Double.valueOf(cvssScore * 10000000);
        order += getEPSSScoreNormalised() * 1000000;

        priorityOrder = order.doubleValue();
    }

    @Override
    public int compareTo(TrivyScanVulnerability o) {
        if (o == null) return -1;

//        int comp = o.getInternalPriorityOrder().compareTo(this.getInternalPriorityOrder());
        int comp = Double.valueOf(o.priorityOrder - this.priorityOrder).intValue();
        if (comp != 0) return comp;

        return this.vulnerabilityID.compareTo(o.vulnerabilityID);
    }
}